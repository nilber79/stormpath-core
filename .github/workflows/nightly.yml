name: Nightly Data Refresh

on:
  # Run every night at 3 AM Eastern (08:00 UTC)
  schedule:
    - cron: '0 8 * * *'
  # Allow manual trigger from the Actions tab
  workflow_dispatch:
    inputs:
      area:
        description: 'Area slug to rebuild (leave blank for all)'
        required: false
        default: ''

jobs:
  # Re-use the same discovery + area build logic as build.yml
  # The core image is NOT rebuilt nightly (no app code changes expected).

  discover:
    name: Discover areas
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Build area matrix
        id: set
        run: |
          if [ -n "${{ github.event.inputs.area }}" ]; then
            slugs='["${{ github.event.inputs.area }}"]'
          else
            # Exclude areas whose config.yaml contains _skip_build: true
            slugs=$(for dir in $(ls areas/); do
              if ! grep -q '_skip_build: true' "areas/$dir/config.yaml" 2>/dev/null; then
                echo "$dir"
              fi
            done | jq -R . | jq -sc .)
          fi
          echo "matrix={\"area\":$slugs}" >> $GITHUB_OUTPUT

  area:
    name: Refresh ${{ matrix.area }}
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install requests shapely pyproj pyyaml

      - name: Rebuild roads (Overpass API)
        run: |
          python scripts/rebuild_roads.py \
            areas/${{ matrix.area }}/config.yaml \
            --output build-output/data/

      - name: Get Geofabrik Last-Modified date
        id: pbf-date
        run: |
          url=$(python -c "
          import yaml
          cfg = yaml.safe_load(open('areas/${{ matrix.area }}/config.yaml'))
          print(cfg['data']['geofabrik_url'])
          ")
          date=$(curl -sI "$url" | grep -i last-modified | sed 's/.*: //' | tr -d '\r')
          echo "date=$date" >> $GITHUB_OUTPUT

      - name: Cache Geofabrik PBF
        uses: actions/cache@v4
        with:
          path: /tmp/geofabrik-cache
          key: geofabrik-${{ matrix.area }}-${{ steps.pbf-date.outputs.date }}
          restore-keys: |
            geofabrik-${{ matrix.area }}-

      # Cache the PMTiles output by PBF date â€” if the Geofabrik data hasn't
      # changed since the last build, skip Planetiler entirely.
      - name: Cache PMTiles output
        id: tiles-cache
        uses: actions/cache@v4
        with:
          path: build-output/tiles/
          key: pmtiles-${{ matrix.area }}-${{ steps.pbf-date.outputs.date }}

      - name: Update PMTiles
        if: steps.tiles-cache.outputs.cache-hit != 'true'
        run: |
          python scripts/update_pmtiles.py \
            areas/${{ matrix.area }}/config.yaml \
            --output build-output/tiles/ \
            --cache-dir /tmp/geofabrik-cache

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Derive image tag
        id: tag
        run: |
          slug=$(echo "${{ matrix.area }}" | tr '_' '-')
          echo "val=${slug}-latest" >> $GITHUB_OUTPUT

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.area
          push: true
          build-args: |
            AREA=${{ matrix.area }}
            GHCR_ORG=${{ github.repository_owner }}
          tags: ghcr.io/${{ github.repository_owner }}/stormpath:${{ steps.tag.outputs.val }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
