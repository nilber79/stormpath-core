name: Build & Publish

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      area:
        description: 'Area slug to build (leave blank for all)'
        required: false
        default: ''

jobs:
  # ── Build the area-agnostic core image ─────────────────────────────────────
  core:
    name: Build core image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.core
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/signalpath-core:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── Discover area directories ───────────────────────────────────────────────
  discover:
    name: Discover counties
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Build area matrix
        id: set
        run: |
          if [ -n "${{ github.event.inputs.area }}" ]; then
            slugs='["${{ github.event.inputs.area }}"]'
          else
            # Exclude areas whose config.yaml contains _skip_build: true
            slugs=$(for dir in $(ls areas/); do
              if ! grep -q '_skip_build: true' "areas/$dir/config.yaml" 2>/dev/null; then
                echo "$dir"
              fi
            done | jq -R . | jq -sc .)
          fi
          echo "matrix={\"area\":$slugs}" >> $GITHUB_OUTPUT

  # ── Build one area image per directory ─────────────────────────────────────
  area:
    name: Build ${{ matrix.area }}
    needs: [core, discover]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      # ── Python data pipeline ──────────────────────────────────────────────────
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install requests shapely pyproj pyyaml

      - name: Rebuild roads (Overpass API)
        run: |
          python scripts/rebuild_roads.py \
            areas/${{ matrix.area }}/config.yaml \
            --output build-output/data/

      # ── PMTiles (cached by Geofabrik Last-Modified date) ─────────────────────
      - name: Get Geofabrik Last-Modified date
        id: pbf-date
        run: |
          url=$(python -c "
          import yaml, sys
          cfg = yaml.safe_load(open('areas/${{ matrix.area }}/config.yaml'))
          print(cfg['data']['geofabrik_url'])
          ")
          date=$(curl -sI "$url" | grep -i last-modified | sed 's/.*: //' | tr -d '\r')
          echo "date=$date" >> $GITHUB_OUTPUT

      - name: Cache Geofabrik PBF
        uses: actions/cache@v4
        with:
          path: /tmp/geofabrik-cache
          key: geofabrik-${{ matrix.area }}-${{ steps.pbf-date.outputs.date }}
          restore-keys: |
            geofabrik-${{ matrix.area }}-

      - name: Update PMTiles
        run: |
          python scripts/update_pmtiles.py \
            areas/${{ matrix.area }}/config.yaml \
            --output build-output/tiles/ \
            --cache-dir /tmp/geofabrik-cache

      # ── Docker build & push ───────────────────────────────────────────────────
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Derive image tag
        id: tag
        run: |
          slug=$(echo "${{ matrix.area }}" | tr '_' '-')
          echo "val=${slug}-latest" >> $GITHUB_OUTPUT

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.area
          push: true
          build-args: |
            AREA=${{ matrix.area }}
            GHCR_ORG=${{ github.repository_owner }}
          tags: ghcr.io/${{ github.repository_owner }}/signalpath:${{ steps.tag.outputs.val }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
