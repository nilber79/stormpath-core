# StormPath — Behind Existing Reverse Proxy
# ─────────────────────────────────────────────────────────────────────────────
# Use this compose file if you already have a reverse proxy (Caddy, Nginx, Traefik)
# handling TLS for your server. StormPath runs on HTTP internally (port 80)
# and your proxy routes traffic to it.
#
# Caddy example (add to your Caddyfile):
#   roadstatus.yourcounty.gov {
#       reverse_proxy stormpath:80
#       import tls_external   # or your existing TLS snippet
#   }
#
# The container name "stormpath" must be reachable from your proxy container
# (put both on the same Docker network, e.g. caddy-net).

services:
  stormpath:
    image: ghcr.io/${GHCR_ORG:-philreblin}/stormpath:${AREA_TAG:-morgan-tn-latest}
    restart: unless-stopped
    environment:
      SERVER_NAME: ":80"   # HTTP only — TLS handled by upstream proxy
      # Password for /admin.php and /phpliteadmin.php — change before going live
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:-changeme}"
    volumes:
      - stormpath-db:/app/public/data
    networks:
      - proxy-net   # Change this to match your proxy's network name

  # Watchtower automatically pulls and restarts StormPath whenever a new
  # nightly image is published to GHCR — no manual update steps required.
  watchtower:
    image: nickfedor/watchtower:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # Check for a new image every hour; only watch the stormpath container.
    command: --interval 3600 stormpath

volumes:
  stormpath-db:

networks:
  proxy-net:
    external: true   # Must already exist; created by your proxy stack
