# StormPath — Standalone Deployment
# ─────────────────────────────────────────────────────────────────────────────
# This compose file is for users deploying StormPath on a fresh server with
# NO existing reverse proxy. FrankenPHP/Caddy handles TLS automatically via
# Let's Encrypt when DOMAIN is set to a real hostname.
#
# Quick start:
#   1. Copy this file and .env.example to the same directory
#   2. cp .env.example .env  &&  nano .env   (set your DOMAIN and AREA_TAG)
#   3. docker compose up -d
#   4. Open https://your.domain in a browser

services:
  stormpath:
    image: ghcr.io/${GHCR_ORG:-philreblin}/stormpath:${AREA_TAG:-morgan-tn-latest}
    restart: unless-stopped
    environment:
      # Set to your real domain for auto-TLS, or ":80" to serve HTTP only
      SERVER_NAME: "${DOMAIN:-localhost}"
      # Password for /admin.php and /phpliteadmin.php — change before going live
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:-changeme}"
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"   # HTTP/3
    volumes:
      # Persist reports.db across image updates.
      # Roads data (roads_optimized.jsonl) is baked into the image and
      # updated automatically when the container restarts with a new image.
      - stormpath-db:/app/public/data
    cap_add:
      # Required by Caddy to bind to ports < 1024 on some Linux configurations
      - NET_ADMIN

  # Watchtower automatically pulls and restarts StormPath whenever a new
  # nightly image is published to GHCR — no manual update steps required.
  watchtower:
    image: nickfedor/watchtower:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # Check for a new image every hour; only watch the stormpath container.
    command: --interval 3600 stormpath

volumes:
  stormpath-db:
